<!doctype html>
<html>
<head>
<title>Pitch Detector and Emitter</title>
<link href="style.css" rel="stylesheet" type="text/css" media="screen" />
<link href='http://fonts.googleapis.com/css?family=Alike' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">


<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>

<script src="js/deque.js"></script>
<script src="js/parseData.js"></script>

<script>
    // Set up moment
    moment().format();

    var minFreq = 440;
    var maxFreq = 880;

    var isPaused = false;

    // This function will be called after sending data to the server.
    var receivedInstructions = function (data, textStatus, jqHXR) {
        makePaused = data["pause"];
        // We don't do anything unless the desired state is different
        // from the current state.
        if (isPaused != makePaused) {
            toggleLiveInput(makePaused);
        }
    }

    var getInstructions = function () {
        var data = {
            session: "admin" // Special session means send out instructions.
        }
        $.ajax({
            type: "POST",
            url: "http://droova.com/python/cicada_view.py",
            data: data,
            dataType: 'json',
            success: receivedInstructions,
        });

    }

    // This function will be called to send data back to server.
    var sendData = function sendData() {

        // Need to grab these from an HTML element, eventually.
        var session = 'hi';
        var location = [parseInt(document.getElementById( "xloc" ).value),
                        parseInt(document.getElementById( "yloc" ).value)];
        var location = JSON.stringify(location);

        var dt_sent = moment.utc();
        // We use this format, rather than JSON.stringify(dt_sent) because this
        // is how sqlite's DEFAULT CURRENT_TIMESTAMP formats the datetime.
        dt_sent = dt_sent.format('YYYY-MM-DD HH:mm:ss');

        var frequency_out = parseFloat($("#note").html());
        var frequency_in = $("#pitch").html();
        if (frequency_in !== "--") {
            frequency_in = parseFloat(frequency_in);
        }

        var data = {
            session: session,
            location: location,
            dt_sent: dt_sent,
            frequency_in: frequency_in,
            frequency_out: frequency_out
            //frequency_out: Math.random() * (maxFreq - minFreq) + minFreq
        };
        //console.log(data);

        // Send it away!
        $.ajax({
            type: "POST",
            url: "http://droova.com/cicada/db.php",
            data: data
        });

    };

    // Only after all elements have loaded.
    // (The following runs every 5 seconds)
    $(window).load(function () {
        setInterval(getInstructions, 5000); // 5 seconds
        
        $("#initialPitch").change( function() {
            $("#note").html( document.getElementById( "initialPitch" ).value );
        });
    });

</script>


<style>
body { font: 14pt 'Alike', sans-serif;}
#note { font-size: 164px; line-height: 90%;}
.droptarget { background-color: #348781}
div.confident { color: black; }
div.vague { color: lightgrey; }

#detector { width: 300px; height: 300px; border: 4px solid gray; border-radius: 8px; text-align: center; padding-top: 10px;}
#output { width: 300px; height: 42px; }
#flat { display: none; }
#sharp { display: none; }
.flat #flat { display: inline; }
.sharp #sharp { display: inline; }

#coordinates {
    min-width: 300px;
}

#coordinates td {
    padding: 10px;
}

#positionMessage {
    text-align: center;
    color: red;
}

#startStopButton {
    cursor: pointer;
    cursor: hand;
    min-width: 150px;
    text-align: center;
}
</style>

</head>
<body>
<script src="js/PitchDetect/pitchdetect.js"></script>

<!--BCD 12.22.2014 include p5.js code-->
<script language="javascript" src="js/p5js/p5.js"></script>
<script language="javascript" src="js/p5js/p5.sound.js"></script>
<script language="javascript" src="js/pitchoutput.js"></script>
<!--BCD end-->

<div align="center">

<!-- Detector and output text -->
<div id="detector" class="vague">
<div>Heard</div>
<div class="pitch"><span id="pitch">--</span> Hz</div>
<canvas id="waveform" width="256" height="64"></canvas>
<div>Output</div>
<div class="note"><span id="note">880</span></div>
<!--<canvas id="output" width=300 height=42></canvas>-->
<div id="detune"><span id="detune_amt"></span><span id="flat">cents &#9837;</span><span id="sharp">cents &#9839;</span></div>
</div>


<!-- Start button -->
<p>
<button id="startStopButton" type="button" onclick="return toggleLiveInput()">Start!</button>
</p>

<!-- Location input -->
<div align="center">
<table id="coordinates">
<tr>
    <td>Horizontal coordinate:</td>
    <td>
        <select id="xloc">
            <option value="-1"></option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
      </select>
    </td>
</tr>
<tr>
    <td>Vertical coordinate:</td>
    <td>
        <select id="yloc">
            <option value="-1"></option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
        </select>
    </td>
</tr>
</table>
<p>
    <span id="positionMessage"></span>
<p>
</div>

<!-- Learning parameters input -->
<div>
Learning rate: Slow <input type="range" id="learningRate" min="0" max="100" value="50" /> Fast
</div>
<div>
Desired interval: 0 <input type="range" id="desiredInterval" min="0" max="3" value="0"/> 1/2 octave
</div>

<!-- Pitch control input -->
<div>
Manually set pitch: <input type="range" id="initialPitch" min="440" max="880" value="500" />
</div>


</div>

</body>
</html>
